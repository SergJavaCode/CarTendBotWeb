<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .required::after {
            content: " *";
            color: #ff4757;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            color: #667eea;
        }
        
        .error-message {
            color: #ff4757;
            text-align: center;
            margin-top: 15px;
            display: none;
            font-size: 14px;
            padding: 10px;
            background: #ffeaea;
            border-radius: 8px;
        }
        
        .success-message {
            color: #2ed573;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h1>
        
        <form id="carForm">
            <div class="form-group">
                <label for="year" class="required">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                <input type="text" id="year" placeholder="2020" required>
            </div>
            
            <div class="form-group">
                <label for="vin" class="required">VIN –Ω–æ–º–µ—Ä</label>
                <input type="text" id="vin" placeholder="WF0XXX12345678901" required>
            </div>
            
            <div class="form-group">
                <label for="plate" class="required">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                <input type="text" id="plate" placeholder="–ê123–ë–í777" required>
            </div>
            
            <div class="form-group">
                <label for="engine" class="required">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                <input type="text" id="engine" placeholder="B58B30" required>
            </div>
            
            <div class="form-group">
                <label for="mileage" class="required">–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
                <input type="number" id="mileage" placeholder="50000" required>
            </div>
            
            <div class="form-group">
                <label for="color" class="required">–¶–≤–µ—Ç</label>
                <input type="text" id="color" placeholder="–°–∏–Ω–∏–π –º–µ—Ç–∞–ª–ª–∏–∫" required>
            </div>
            
            <button type="button" class="submit-btn" id="submitBtn" onclick="sendData()">
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
            
            <div id="loading" class="loading">
                ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
            
            <div id="errorMessage" class="error-message">
                ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                <div id="errorDetails"></div>
            </div>
            
            <div id="successMessage" class="success-message">
                ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!
            </div>
            
            <div id="debugInfo" class="debug-info">
                –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª–∏
            </div>
        </form>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function sendData() {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            const successMessage = document.getElementById('successMessage');
            const debugInfo = document.getElementById('debugInfo');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            debugInfo.style.display = 'none';
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const carData = {
                year: document.getElementById('year').value.trim(),
                vin: document.getElementById('vin').value.trim(),
                plate: document.getElementById('plate').value.trim(),
                engine: document.getElementById('engine').value.trim(),
                mileage: parseInt(document.getElementById('mileage').value) || 0,
                color: document.getElementById('color').value.trim()
            };
            
            console.log('–°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:', carData);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!carData.year || !carData.vin || !carData.plate || !carData.engine || !carData.color) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }
            
            if (carData.vin.length !== 17) {
                alert('VIN –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 17 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = getTelegramUserData();
            if (!userData || !userData.id) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageData = getMessageData();
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const dataToSend = {
                type: "car_data",
                user: userData,
                car: carData,
                message_data: messageData,
                timestamp: new Date().toISOString(),
                webapp_init_data: window.Telegram?.WebApp?.initData || null
            };
            
            console.log('–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', JSON.stringify(dataToSend, null, 2));
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            submitBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                
                const response = await fetch('https://195.133.197.49/carinfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dataToSend),
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', result);
                    showSuccess();
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞ ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
                
                let errorText = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. ';
                if (error.name === 'AbortError') {
                    errorText += '–¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥).';
                } else if (error.name === 'TypeError') {
                    errorText += '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ CORS.';
                } else {
                    errorText += error.message;
                }
                
                showError(errorText);
                debugInfo.style.display = 'block';
                
            } finally {
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        function getTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                return user ? {
                    id: user.id,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    username: user.username,
                    language_code: user.language_code,
                    is_premium: user.is_premium
                } : null;
            }
            return null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è
        function getMessageData() {
            if (window.Telegram && window.Telegram.WebApp) {
                return {
                    message_id: Telegram.WebApp.initDataUnsafe.start_param,
                    inline_message_id: Telegram.WebApp.initDataUnsafe.inline_message_id,
                    chat_id: Telegram.WebApp.initDataUnsafe.chat_instance
                };
            }
            return null;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        function showSuccess() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.close();
                }
            }, 2000);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            
            errorDetails.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ WebApp –∑–∞–≥—Ä—É–∂–µ–Ω!');
            
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                console.log('üìä InitDataUnsafe:', Telegram.WebApp.initDataUnsafe);
                console.log('üë§ User:', Telegram.WebApp.initDataUnsafe.user);
                console.log('üí¨ Start param:', Telegram.WebApp.initDataUnsafe.start_param);
            } else {
                console.log('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏');
            }
            
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (new URLSearchParams(window.location.search).has('test')) {
                document.getElementById('year').value = '2022';
                document.getElementById('vin').value = 'WF0XXX12345678901';
                document.getElementById('plate').value = '–ê123–ë–í777';
                document.getElementById('engine').value = 'B58B30';
                document.getElementById('mileage').value = '50000';
                document.getElementById('color').value = '–°–∏–Ω–∏–π –º–µ—Ç–∞–ª–ª–∏–∫';
                console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ Enter
            document.getElementById('carForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendData();
                }
            });
        });
    </script>
</body>
</html>
