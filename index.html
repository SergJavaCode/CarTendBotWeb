<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .required::after {
            content: " *";
            color: #ff4757;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            color: #667eea;
        }
        
        .error-message {
            color: #ff4757;
            text-align: center;
            margin-top: 15px;
            display: none;
            font-size: 14px;
            padding: 10px;
            background: #ffeaea;
            border-radius: 8px;
        }
        
        .success-message {
            color: #2ed573;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h1>
        
        <form id="carForm">
            <div class="form-group">
                <label for="year" class="required">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                <input type="text" id="year" placeholder="2020" required>
            </div>
            
            <div class="form-group">
                <label for="vin" class="required">VIN –Ω–æ–º–µ—Ä</label>
                <input type="text" id="vin" placeholder="WF0XXX12345678901" required>
            </div>
            
            <div class="form-group">
                <label for="plate" class="required">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                <input type="text" id="plate" placeholder="–ê123–ë–í777" required>
            </div>
            
            <div class="form-group">
                <label for="engine" class="required">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                <input type="text" id="engine" placeholder="B58B30" required>
            </div>
            
            <div class="form-group">
                <label for="mileage" class="required">–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
                <input type="number" id="mileage" placeholder="50000" required>
            </div>
            
            <div class="form-group">
                <label for="color" class="required">–¶–≤–µ—Ç</label>
                <input type="text" id="color" placeholder="–°–∏–Ω–∏–π –º–µ—Ç–∞–ª–ª–∏–∫" required>
            </div>
            
            <button type="button" class="submit-btn" id="submitBtn" onclick="sendDataToServer()">
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
            
            <div id="loading" class="loading">
                ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
            
            <div id="errorMessage" class="error-message">
                ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                <div id="errorDetails"></div>
                <button class="retry-btn" onclick="sendDataToServer()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
            
            <div id="successMessage" class="success-message">
                ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!
            </div>
        </form>
    </div>

    <script>
        let telegramUser = null;
        let messageId = null;
        let inlineMessageId = null;
        let carData = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ initData
        function parseInitData(initData) {
            const params = new URLSearchParams(initData);
            const result = {};
            
            for (const [key, value] of params) {
                result[key] = value;
            }
            return result;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ initData
        function getInitData() {
            if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initData) {
                return parseInitData(Telegram.WebApp.initData);
            }
            return null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        function getTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp) {
                return {
                    id: Telegram.WebApp.initDataUnsafe.user?.id,
                    first_name: Telegram.WebApp.initDataUnsafe.user?.first_name,
                    last_name: Telegram.WebApp.initDataUnsafe.user?.last_name,
                    username: Telegram.WebApp.initDataUnsafe.user?.username,
                    language_code: Telegram.WebApp.initDataUnsafe.user?.language_code,
                    is_premium: Telegram.WebApp.initDataUnsafe.user?.is_premium
                };
            }
            return null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è message_id –∏–∑ initData
        function getMessageData() {
            const initData = getInitData();
            if (initData) {
                return {
                    message_id: initData.start_param || initData.message_id || null,
                    inline_message_id: initData.inline_message_id || null,
                    chat_id: initData.chat_id || initData.chat_instance || null
                };
            }
            return null;
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram WebApp
        function sendViaTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    const dataToSend = {
                        type: "car_data",
                        user: telegramUser,
                        car: carData,
                        message_data: getMessageData(),
                        timestamp: new Date().toISOString()
                    };
                    
                    Telegram.WebApp.sendData(JSON.stringify(dataToSend));
                    Telegram.WebApp.close();
                    return true;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram:', error);
                    return false;
                }
            }
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendDataToServer() {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            const successMessage = document.getElementById('successMessage');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            carData = {
                year: document.getElementById('year').value.trim(),
                vin: document.getElementById('vin').value.trim(),
                plate: document.getElementById('plate').value.trim(),
                engine: document.getElementById('engine').value.trim(),
                mileage: parseInt(document.getElementById('mileage').value) || 0,
                color: document.getElementById('color').value.trim()
            };
            
            console.log('–°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:', carData);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!carData.year || !carData.vin || !carData.plate || !carData.engine || !carData.color) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }
            
            if (carData.vin.length !== 17) {
                alert('VIN –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 17 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            telegramUser = getTelegramUserData();
            if (!telegramUser || !telegramUser.id) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageData = getMessageData();
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const dataToSend = {
                type: "car_data",
                user: telegramUser,
                car: carData,
                message_data: messageData,
                timestamp: new Date().toISOString(),
                webapp_init_data: window.Telegram?.WebApp?.initData || null
            };
            
            console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', dataToSend);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            submitBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // –¢–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥
                
                const response = await fetch('https://195.133.197.49/carinfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend),
                    signal: controller.signal,
                    mode: 'cors' // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∂–∏–º CORS
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', result);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    successMessage.style.display = 'block';
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (window.Telegram && window.Telegram.WebApp) {
                            Telegram.WebApp.close();
                        }
                    }, 2000);
                    
                } else {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram
                if (error.name === 'TypeError' || error.name === 'AbortError') {
                    console.log('–ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram WebApp...');
                    if (sendViaTelegram()) {
                        successMessage.style.display = 'block';
                        successMessage.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram!';
                        return;
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorText = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. ';
                
                if (error.name === 'AbortError') {
                    errorText += '–¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.';
                } else if (error.name === 'TypeError') {
                    errorText += '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ CORS.';
                } else {
                    errorText += error.message;
                }
                
                errorDetails.textContent = errorText;
                errorMessage.style.display = 'block';
                
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('WebApp –∑–∞–≥—Ä—É–∂–µ–Ω!');
            
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                telegramUser = getTelegramUserData();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramUser);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                const messageData = getMessageData();
                console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);
            }
            
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (new URLSearchParams(window.location.search).has('test')) {
                document.getElementById('year').value = '2022';
                document.getElementById('vin').value = 'WF0XXX12345678901';
                document.getElementById('plate').value = '–ê123–ë–í777';
                document.getElementById('engine').value = 'B58B30';
                document.getElementById('mileage').value = '50000';
                document.getElementById('color').value = '–°–∏–Ω–∏–π –º–µ—Ç–∞–ª–ª–∏–∫';
                
                // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                telegramUser = {
                    id: 123456789,
                    first_name: "Test",
                    last_name: "User",
                    username: "testuser",
                    language_code: "ru",
                    is_premium: true
                };
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ Enter
            document.getElementById('carForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendDataToServer();
                }
            });
        });
    </script>
</body>
</html>
